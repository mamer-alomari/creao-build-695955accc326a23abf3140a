rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isCompanyMember(companyId) {
      return isAuthenticated() && getUserData().companyId == companyId;
    }

    function isManager(companyId) {
      return isCompanyMember(companyId) && (getUserData().role == 'manager' || getUserData().role == 'admin');
    }

    function isForeman(companyId) {
      return isCompanyMember(companyId) && (getUserData().role == 'foreman' || getUserData().role == 'manager' || getUserData().role == 'admin');
    }

    function isWorkerOrAbove(companyId) {
      return isCompanyMember(companyId) && (getUserData().role == 'worker' || getUserData().role == 'foreman' || getUserData().role == 'manager' || getUserData().role == 'admin');
    }

    // Users: Users can read/write their own profile
    match /users/{userId} {
      allow read, write: if isUser(userId);
    }

    // Companies:
    // Create: Allow if authenticated (onboarding)
    // Read: Any authenticated user can read (needed for onboarding company lookup & invite acceptance)
    // Update: Only members of this company
    match /companies/{companyId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update: if isCompanyMember(companyId);
    }

    // Jobs
    // Jobs - Managed by Foreman+; customers can read their own
    match /jobs/{jobId} {
      allow read: if isCompanyMember(resource.data.company_id) 
                  || (isAuthenticated() && resource.data.customer_id == request.auth.uid);
      allow create: if isForeman(request.resource.data.company_id)
                    || (isAuthenticated() && request.resource.data.customer_id == request.auth.uid);
      allow update, delete: if isForeman(resource.data.company_id);
    }

    // Workers
    // Workers - Managed by Managers
    match /workers/{workerId} {
      allow read: if isCompanyMember(resource.data.company_id);
      allow create: if isManager(request.resource.data.company_id);
      allow update, delete: if isManager(resource.data.company_id);
    }

    // Vehicles
    match /vehicles/{vehicleId} {
        allow read: if isCompanyMember(resource.data.company_id);
        allow create: if isCompanyMember(request.resource.data.company_id);
        allow update: if isCompanyMember(resource.data.company_id) && isCompanyMember(request.resource.data.company_id);
        allow delete: if isCompanyMember(resource.data.company_id);
    }

    // Maintenance Records
    match /maintenance_records/{recordId} {
        allow read: if isCompanyMember(resource.data.company_id);
        allow create: if isCompanyMember(request.resource.data.company_id);
        allow update: if isCompanyMember(resource.data.company_id) && isCompanyMember(request.resource.data.company_id);
        allow delete: if isCompanyMember(resource.data.company_id);
    }

    // Equipment
    match /equipment/{equipmentId} {
        allow read: if isCompanyMember(resource.data.company_id);
        allow create: if isCompanyMember(request.resource.data.company_id);
        allow update: if isCompanyMember(resource.data.company_id) && isCompanyMember(request.resource.data.company_id);
        allow delete: if isCompanyMember(resource.data.company_id);
    }

    // Payroll
     match /payroll_records/{recordId} {
        allow read: if isCompanyMember(resource.data.company_id);
        allow create: if isCompanyMember(request.resource.data.company_id);
        allow update: if isCompanyMember(resource.data.company_id) && isCompanyMember(request.resource.data.company_id);
        allow delete: if isCompanyMember(resource.data.company_id);
    }

    // Assignments
    // Assignments - Managed by Foreman+
    match /job_worker_assignments/{id} {
        allow read: if isCompanyMember(resource.data.company_id);
        allow create: if isForeman(request.resource.data.company_id);
        allow update, delete: if isForeman(resource.data.company_id);
    }

    match /job_vehicle_assignments/{id} {
        allow read: if isCompanyMember(resource.data.company_id);
        allow create: if isForeman(request.resource.data.company_id);
        allow update, delete: if isForeman(resource.data.company_id);
    }

    match /job_equipment_allocations/{id} {
        allow read: if isCompanyMember(resource.data.company_id);
        allow create: if isForeman(request.resource.data.company_id);
        allow update, delete: if isForeman(resource.data.company_id);
    }

    // Invitations
    match /invitations/{token} {
        // Managers can manage their company's invitations
        allow list, delete: if isCompanyMember(resource.data.company_id);
        allow create: if isCompanyMember(request.resource.data.company_id);
        
        // Anyone with the token can read it (to verify)
        allow get: if true;
        
        // The invitee can update it (to mark accepted) after signup
        allow update: if request.auth != null && request.auth.token.email == resource.data.email;
    }

    // Incidents
    match /incidents/{id} {
        allow read: if isCompanyMember(resource.data.company_id);
        allow create: if isCompanyMember(request.resource.data.company_id);
        allow update: if isForeman(resource.data.company_id); // Only Foreman+ can resolve
    }

    // Worker Locations (GPS)
    match /worker_locations/{workerId} {
        allow read: if isCompanyMember(resource.data.company_id);
        allow write: if isUser(workerId);
    }

    // Quotes / Inquiries (Public Submission)
    match /quotes/{quoteId} {
        allow create: if true; // Public lead capture
        allow read, update, delete: if (resource.data.customer_id == request.auth.uid) || (resource.data.company_id != null && isCompanyMember(resource.data.company_id));
    }

    // Storage Facilities
    match /storage_facilities/{facilityId} {
        allow read: if isCompanyMember(resource.data.company_id);
        allow create: if isCompanyMember(request.resource.data.company_id);
        allow update: if isCompanyMember(resource.data.company_id);
        allow delete: if isManager(resource.data.company_id);
    }

    // Worker Schedules
    match /worker_schedules/{scheduleId} {
        allow read: if isCompanyMember(resource.data.company_id)
                    || isUser(resource.data.worker_id);
        allow create: if isWorkerOrAbove(request.resource.data.company_id);
        allow update: if isWorkerOrAbove(resource.data.company_id);
        allow delete: if isForeman(resource.data.company_id);
    }

    // Equipment Schedules
    match /equipment_schedules/{scheduleId} {
        allow read: if isCompanyMember(resource.data.company_id);
        allow create: if isForeman(request.resource.data.company_id);
        allow update, delete: if isForeman(resource.data.company_id);
    }

    // Vehicle Schedules
    match /vehicle_schedules/{scheduleId} {
        allow read: if isCompanyMember(resource.data.company_id);
        allow create: if isForeman(request.resource.data.company_id);
        allow update, delete: if isForeman(resource.data.company_id);
    }
  }
}
